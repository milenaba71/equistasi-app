<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Equistasi – Clinica 3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
html,body{margin:0;height:100%;font-family:system-ui;background:#fff}
.app{display:grid;grid-template-columns:380px 1fr;height:100vh}

/* ===== LEFT PANEL ===== */
.left{background:#f4f6f8;border-right:1px solid #ccc;padding:14px;overflow:auto}
h1{font-size:18px;margin:0 0 10px}
label{font-size:12px;color:#555;margin-top:8px;display:block}
input,select,textarea{width:100%;margin-top:4px;padding:6px;font-size:13px}
textarea{min-height:60px}

/* ===== RIGHT VIEWER ===== */
.right{position:relative;background:#fff}
.viewerWrap{position:absolute;inset:0}
iframe{width:100%;height:100%;border:none;background:#fff}

/* ===== LOGO ===== */
.logo{
position:absolute;top:10px;right:10px;z-index:10;
background:#fff;border:1px solid #ccc;border-radius:8px;padding:6px 10px
}
.logo img{height:26px}

/* ===== POINTS ===== */
.pointsLayer{position:absolute;inset:0;z-index:8}
.point{
position:absolute;transform:translate(-50%,-50%);
width:16px;height:16px;border-radius:50%;
background:#2b7bff;border:2px solid #fff;cursor:pointer
}
.point::after{
content:attr(data-label);
position:absolute;left:18px;top:-6px;
background:#fff;border:1px solid #aaa;
padding:2px 6px;border-radius:6px;font-size:12px
}

/* ===== PRINT IMAGE ===== */
.printImageBox{display:none;margin-top:10px}
.printImageBox img{width:100%;border:1px solid #ccc}

/* ===== BUTTON ===== */
button{margin-top:8px;padding:8px 10px;font-size:13px}

/* ===== MOBILE ===== */
@media (max-width:900px){
.left{display:none}
.app{grid-template-columns:1fr}
}

/* ===== PRINT ===== */
@media print{
.right,.logo,.pointsLayer,button{display:none!important}
.printImageBox{display:block}
}
</style>
</head>

<body>
<div class="app">

<!-- ===== LEFT PANEL ===== -->
<aside class="left">
<h1>Equistasi – Scheda clinica</h1>

<label>Paziente</label>
<input id="patient">

<label>Data</label>
<input type="date" id="date">

<label>Protocollo</label>
<select id="protocol">
<option>Cervicale</option>
<option>Spalla</option>
<option>Dorsale</option>
<option>Lombare</option>
<option>Anca</option>
<option>Ginocchio</option>
</select>

<label>Legenda punti Equistasi</label>
<textarea id="legend" placeholder="P1: C7 paravertebrale&#10;P2: margine mediale scapola"></textarea>

<button onclick="printFull()">Stampa PDF completo</button>

<div class="printImageBox">
<h3>Modello 3D con punti Equistasi</h3>
<img id="printImg">
<h3>Legenda punti</h3>
<pre id="legendPrint"></pre>
</div>
</aside>

<!-- ===== VIEWER ===== -->
<main class="right">
<div class="viewerWrap" id="viewerWrap">

<a class="logo" href="https://equistasi.com/contacts" target="_blank">
<img src="./equistasi-logo.png">
</a>

<div class="pointsLayer" id="pointsLayer"></div>

<iframe
src="https://human.biodigital.com/widget/?be=2b5y&background.colors=1,1,1,1,1,1,1,1&ui-center=true&ui-zoom=true&ui-dissect=true&ui-help=true">
</iframe>

</div>
</main>

</div>

<script>
const pointsLayer=document.getElementById("pointsLayer");
const legend=document.getElementById("legend");
const printImg=document.getElementById("printImg");
const legendPrint=document.getElementById("legendPrint");
let points=[];

function nextLabel(){return "P"+(points.length+1)}

document.getElementById("viewerWrap").addEventListener("click",e=>{
if(e.target.classList.contains("point"))return;
const r=pointsLayer.getBoundingClientRect();
const x=((e.clientX-r.left)/r.width)*100;
const y=((e.clientY-r.top)/r.height)*100;
const label=prompt("Nome punto",nextLabel());
if(!label)return;
points.push({x,y,label});
render();
});

function render(){
pointsLayer.innerHTML="";
points.forEach((p,i)=>{
const d=document.createElement("div");
d.className="point";
d.style.left=p.x+"%";
d.style.top=p.y+"%";
d.dataset.label=p.label;
d.ondblclick=e=>{
e.stopPropagation();
points.splice(i,1);
render();
};
pointsLayer.appendChild(d);
});
legend.value=points.map(p=>`${p.label}: descrizione`).join("\n");
}

async function printFull(){
await html2canvas(document.getElementById("viewerWrap"),{backgroundColor:"#fff",scale:2})
.then(c=>printImg.src=c.toDataURL());
legendPrint.textContent=legend.value;
setTimeout(()=>window.print(),300);
}

document.getElementById("date").value=new Date().toISOString().slice(0,10);
</script>
</body>
</html>

